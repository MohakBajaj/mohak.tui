name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Lint and type check
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run typecheck
        continue-on-error: true

  # Build Go TUI server
  build-tui:
    name: Build TUI Server
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
          cache-dependency-path: apps/tui-server/go.sum

      - name: Download dependencies
        working-directory: apps/tui-server
        run: go mod download

      - name: Build
        working-directory: apps/tui-server
        run: go build -v -o bin/tui-server .

      - name: Run tests
        working-directory: apps/tui-server
        run: go test -v ./...
        continue-on-error: true

  # Build AI Gateway
  build-ai:
    name: Build AI Gateway
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        working-directory: apps/ai-gateway
        run: bun build index.ts --outdir=./dist --target=bun

  # Build Docker images
  docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-tui, build-ai]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build TUI Server image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/tui-server.Dockerfile
          push: false
          tags: mohak-tui-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build AI Gateway image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/ai-gateway.Dockerfile
          push: false
          tags: mohak-ai-gateway:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
